{% extends 'base.html' %}
{% load static %}

{% block title_name %}
 <title>Pengemasan | BaliGo Ekspedisi</title>
{% endblock %}

{% block file_css %}
<!-- DataTables -->
 <link rel="stylesheet" href="{% static 'assets/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css' %}">
 <link rel="stylesheet" href="{% static 'assets/plugins/datatables-responsive/css/responsive.bootstrap4.min.css' %}">
 <!-- SweetAlert2 -->
  <link rel="stylesheet" href="{% static 'assets/plugins/sweetalert2-theme-bootstrap-4/bootstrap-4.min.css' %}">
  <style type="text/css">
	@media (max-width: 768px) {
		.buttontext {
			width: 95px;
			overflow: hidden;
			white-space: nowrap;
			display: block;
			text-overflow: ellipsis;
		}
	}
  </style>
{% endblock %}


{% block content_header %}
<div class="container-fluid">
    <div class="row mb-2">
    	<div class="col-sm-6">
            <h1 class="m-0 text-dark">Pengemasan</h1>
        </div><!-- /.col -->
	    <div class="col-sm-6">
	    	<ol class="breadcrumb float-sm-right">
	    		<li class="breadcrumb-item"><a href="#">Home</a></li>
	    		<li class="breadcrumb-item active">Pengemasan</li>
	    	</ol>
	    </div><!-- /.col -->
	</div><!-- /.row -->
</div><!-- /.container-fluid -->
{% endblock %}


{% block content %}
<div class="card">
	<div class="card-header">
		<h3 class="card-title">Data Pengemasan</h3>
		<div class="card-tools">
			<button type="button" class="btn btn-block bg-gradient-primary" id="createPengemasan" title="Tambah Pengemasan">
				<span class="buttontext"><i class="fa fa-plus"></i>&nbsp; Tambah Pengemasan</span>
			</button>
		</div>
	</div>
	<!-- /.card-header -->
	<div class="card-body">
		<table id="pengemasan" class="table table-bordered table-striped">
			<thead>
				<tr>
					<th>No</th>
					<th>ID</th>
					<th>Nama Pengemasan</th>
					<th>Bahan Pengemasan</th>
					<th>Tarif</th>
					<th>Action</th>
				</tr>
			</thead>
			<tbody>
				
			</tbody>
			<tfoot>
				<tr>
					<th>No</th>
					<th>ID</th>
					<th>Nama Pengemasan</th>
					<th>Bahan Pengemasan</th>
					<th>Tarif</th>
					<th>Action</th>
				</tr>
			</tfoot>
		</table>
	</div>
	<!-- /.card-body -->
</div>



<!-- /.modal -->
<div class="modal fade" id="modal_pengemasan">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title" id="title_modal">Detail Data Pengemasan</h4>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
				<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<form id="createPengemasanForm" method="post" data-url="{% url 'pengemasan' %}">
					{% csrf_token %}
					{% for field in form %}
					{% if not field.name == 'id_pengemasan' %}
						<div class="form-group row">
		                    <label for="{{ field.name }}" class="col-sm-2 col-form-label">{{ field.label }}</label>
			                   <div class="col-sm-10">
			                   	{% if field.name == 'tarif' %}
									<div class="input-group">
										<div class="input-group-prepend">
											<span class="input-group-text">Rp.</span>
										</div>
										{{ field }}
										<div class="input-group-append">
											<span class="input-group-text">.00</span>
										</div>
									</div>
			                   	{% else%}
			                      {{ field }}
			                   	{% endif %}
			                   	
			                   </div>
		                </div>

	                 {% endif %}
					{% endfor %}
					<input type="hidden" name="id_pengemasan" id="id_pengemasan">
					<input type="hidden" name="id" id="id">
					
				</form>
			</div>
			<div class="modal-footer justify-content-between">
				<button type="button" class="btn btn-default" data-dismiss="modal">Tutup</button>
				<button type="button" class="btn btn-primary" id="updateButton">Update</button>
				<button type="button" class="btn btn-primary" id="createButton">Simpan</button>
			</div>
		</div>
		<!-- /.modal-content -->
	</div>
	<!-- /.modal-dialog -->
</div>
<!-- /.modal -->
{% endblock %}




{% block file_js %}
<!-- Bootstrap 4 -->
<script src="{% static 'assets/plugins/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
<!-- DataTables -->
<script src="{% static 'assets/plugins/datatables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'assets/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js' %}"></script>
<script src="{% static 'assets/plugins/datatables-responsive/js/dataTables.responsive.min.js' %}"></script>
<script src="{% static 'assets/plugins/datatables-responsive/js/responsive.bootstrap4.min.js' %}"></script>
<!-- SweetAlert2 -->
<script src="{% static 'assets/plugins/sweetalert2/sweetalert2.min.js' %}"></script>

<!-- jquery-mask -->
<script src="{% static 'assets/plugins/jquery-mask/jquery.mask.js' %}"></script>

<script>
	$(document).ready(function(){
		function getCookie(name) {
	        var cookieValue = null;
	        if (document.cookie && document.cookie != '') {
	            var cookies = document.cookie.split(';');
	            for (var i = 0; i < cookies.length; i++) {
	                var cookie = jQuery.trim(cookies[i]);
	                // Does this cookie string begin with the name we want?
	                if (cookie.substring(0, name.length + 1) == (name + '=')) {
	                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
	                    break;
	                }
	            }
	        }
	        return cookieValue;
	    }

		var url_edit = '';
		// Format mata uang.
        $('.tarif').mask('000.000.000', {reverse: true});
        function remove_last_3_char(data){
			var newStr = data.substring(0, data.length - 3);
			return newStr;
        }

		function tampilkan_pesan(pesan, type){
	    	Toast.fire({
	        icon: type,
	        title: pesan
	      });
	    }

		const Toast = Swal.mixin({
	      toast: true,
	      position: 'top-end',
	      showConfirmButton: false,
	      timer: 3000
	    });

		var table = $('#pengemasan').DataTable({
		    "columns": [{
		        "width": "6%"
		        },
		        null,
		        null,
		        null,
		        null, {
		            "width": "20%"
		        },
		    ],
		    "paging": true,
		    "lengthChange": false,
		    "searching": true,
		    "ordering": true,
		    "info": true,
		    "autoWidth": false,
		    "responsive": true,
		    "processing": true,
		    "serverside": true,
		    "ajax": {
		        "url": $("#createPengemasanForm").data('url'),
		        "type": "get"
		    }
		});

		//CREATE DATA (SHOW FORM)
		$("#createPengemasan").click(function(e){
			e.preventDefault();
			$("#createPengemasanForm")[0].reset();
			$("#createButton").prop("disabled", false);
			document.getElementById("updateButton").style.display = "none";
			document.getElementById("createButton").style.display = "block";
			document.getElementById("title_modal").innerHTML = "Tambah Data Pengemasan";

			$('#modal_pengemasan').modal('show');
			
		});


		// CREATE DATA ACTION
		$("#createButton").click(function(e){
			$("#createButton").prop("disabled", true);
			if (!$("#createPengemasanForm").valid()) return;
			document.getElementById("inputTarifPengemasan").value = $('.tarif').cleanVal();
			e.preventDefault();
			var serializeData = $("#createPengemasanForm")[0];
			serializeData = new FormData(serializeData);
			
			$.ajax({
				url: $("#createPengemasanForm").data('url'),
				data: serializeData,
				type: 'post',
				cache: false,
				processData: false,
        		contentType: false,
				success: function(response){
					$('#modal_pengemasan').modal('hide');
					setTimeout(function(){
						table.ajax.reload();
						tampilkan_pesan(response.msg, response.type);
					}, 1000);
					$("#createPengemasanForm")[0].reset();
				},
				error: function(xhr, status, error){
					// $('#modal_pengemasan').modal('hide');
					setTimeout(function(){
					var error_response = xhr.responseJSON;
						tampilkan_pesan(error_response.msg, error_response.type);
					}, 1000)
					$("#createButton").prop("disabled", false);
					
				},
			})
		});


		//BAGIAN DELETE
	    $('body').on('click', '.deletePengemasan', function () {
	        var id_pengemasan = $(this).data("id");
	        var nama_pengemasan = $(this).data("nama");
	        Swal.fire({
			  title: 'Anda yakin?',
			  text: "Yakin menghapus "+ nama_pengemasan +"!",
			  icon: 'warning',
			  showCancelButton: true,
			  confirmButtonColor: '#3085d6',
			  cancelButtonColor: '#d33',
			  confirmButtonText: 'Yes, delete it!',
			}).then((result)=>{
			  if (result.value) {
			  	$.ajax({
			  		url: $("#createPengemasanForm").data('url') + 'delete/',
			  		data: {
			  			csrfmiddlewaretoken: getCookie('csrftoken'),
			  			id: id_pengemasan
			  		},
			  		type: 'post',
			  		dataType: 'json',
			  		success: function(response){
			  			tampilkan_pesan(response.msg, response.type);
			  			table.ajax.reload();
			  		},
			  		error: function(xhr, status, error){
			  			var error_response = xhr.responseJSON;
			  			tampilkan_pesan(error_response.msg, error_response.type);
			  		}
			  	});
			    
			  }
			})
	    });


	    //EDIT DATA SHOW
		$('body').on('click', '.editPengemasan', function(event){
			event.preventDefault();
			$("#updateButton").prop("disabled", false);
			$("#createPengemasanForm")[0].reset();
			var id_pengemasan = $(this).data("id");

			$.ajax({
				url: $("#createPengemasanForm").data('url') + 'detail/',
				type: 'get',
				data: {
					csrfmiddlewaretoken: getCookie('csrftoken'),
			  		id: id_pengemasan
				},
				success: function(response){
					document.getElementById("id").value = response.data.id;
					document.getElementById("inputNama").value = response.data.nama_pengemasan;
					document.getElementById("inputBahanPengemasan").value = response.data.bahan_pengemasan;
					document.getElementById("id_pengemasan").value = response.data.id_pengemasan;
					document.getElementById("inputTarifPengemasan").value = $('.tarif').masked(remove_last_3_char(response.data.tarif));

					document.getElementById("inputNama").disabled = false;
					document.getElementById("inputBahanPengemasan").disabled = false;

					document.getElementById("updateButton").style.display = "block";
					document.getElementById("createButton").style.display = "none";
					document.getElementById("title_modal").innerHTML = "Edit Data Pengemasan";
					
					$('#modal_pengemasan').modal('show');
				}
			})
			
		});


		// Update action
		$("#updateButton").click(function(e){
			e.preventDefault();
			$("#updateButton").prop("disabled", true);
			document.getElementById("inputTarifPengemasan").value = $('.tarif').cleanVal();
			var serializeData = $("#createPengemasanForm").serialize();
			
			$.ajax({
				url: $("#createPengemasanForm").data('url') + 'update/',
				data: serializeData,
				type: 'post',
				cache: false,
				success: function(response){
					table.ajax.reload();
					$('#modal_pengemasan').modal('hide');
					tampilkan_pesan(response.msg, response.type);
					$("#updateButton").prop("disabled", false);
					$("#createPengemasanForm")[0].reset();
				},
				error: function(xhr, status, error){
					var error_response = xhr.responseJSON;
					$("#updateButton").prop("disabled", false);
					tampilkan_pesan(error_response.msg, error_response.type);
					// $("#createPengemasanForm")[0].reset();
					// $('#modal_pengemasan').modal('hide');
				},
			})

			
		});


		$('#modal_pengemasan').on('hide.bs.modal', function(){
			setTimeout(function(){
				var validator = $("#createPengemasanForm").validate();
				validator.resetForm();
			
			})
		});


	});
</script>
{% endblock %}
