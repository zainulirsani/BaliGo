{% extends 'base.html' %}
{% load static %}

{% block title_name %}
 <title>Layanan | BaliGo Ekspedisi</title>
{% endblock %}

{% block file_css %}
<!-- DataTables -->
 <link rel="stylesheet" href="{% static 'assets/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css' %}">
 <link rel="stylesheet" href="{% static 'assets/plugins/datatables-responsive/css/responsive.bootstrap4.min.css' %}">
 <!-- SweetAlert2 -->
  <link rel="stylesheet" href="{% static 'assets/plugins/sweetalert2-theme-bootstrap-4/bootstrap-4.min.css' %}">
  <style type="text/css">
	@media (max-width: 768px) {
		.dataTables_filter, .dataTables_length {
			float: left;
		}
	}

  	.map_size {
  		width: 100%;
  		height: 350px;
  	}
  	#maps_tracking {
  		width: 100%;
  		height: 350px;
  	}

	.leaflet-top, .leaflet-bottom {
  		z-index: 400; 
  	}

  	@media (max-width: 768px) {
  		#no_th{
  			font-size: small;
  		}
  		#nama_layanan_th{
  			font-size: small;
  		}
  		#estimasi_th{
  			font-size: small;
  		}
  		#deskripsi_th{
  			font-size: small;
  		}
		.buttontext {
			width: 95px;
			overflow: hidden;
			white-space: nowrap;
			display: block;
			text-overflow: ellipsis;
		}
	}
  </style>
{% endblock %}


{% block content_header %}
<div class="container-fluid">
    <div class="row mb-2">
    	<div class="col-sm-6">
            <h1 class="m-0 text-dark">Layanan</h1>
        </div><!-- /.col -->
	    <div class="col-sm-6">
	    	<ol class="breadcrumb float-sm-right">
	    		<li class="breadcrumb-item"><a href="#">Home</a></li>
	    		<li class="breadcrumb-item active">Layanan</li>
	    	</ol>
	    </div><!-- /.col -->
	</div><!-- /.row -->
</div><!-- /.container-fluid -->
{% endblock %}



{% block content %}
<div class="card">
	<div class="card-header">
		<h3 class="card-title">Data Layanan</h3>
		<div class="card-tools">
			<button type="button" class="btn btn-block bg-gradient-primary" id="createLayanan">
				<span class="buttontext"><i class="fa fa-plus"></i>&nbsp; Tambah Layanan</span>
			</button>
		</div>
	</div>
	<!-- /.card-header -->
	<div class="card-body">
		<table id="tabel-layanan" class="table table-bordered table-striped">
			<thead>
				<tr>
					<th id="no_th">No</th>
					<th id="nama_layanan_th">Nama Layanan</th>
					<th id="estimasi_th">Estimasi (Hari)</th>
					<th id="deskripsi_th">Deskripsi</th>
					<th>Status Layanan</th>
					<th>Action</th>
				</tr>
			</thead>
			<tbody>
				
			</tbody>
			<tfoot>
				<tr>
					<th>No</th>
					<th>Nama Layanan</th>
					<th>Estimasi (Hari)</th>
					<th>Deskripsi</th>
					<th>Status Layanan</th>
					<th>Action</th>
				</tr>
			</tfoot>
		</table>
	</div>
	<!-- /.card-body -->
</div>



<!-- /.modal -->
<div class="modal fade" id="modal_layanan">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title" id="title_modal">Detail Data Layanan</h4>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
				<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<form id="createLayananForm" method="post" data-url="{% url 'layanan' %}">
					{% csrf_token %}
					{% for field in form %}
						<div class="form-group row">
		                   <label for="{{ field.name }}" class="col-sm-2 col-form-label">{{ field.label }}</label>
							{% if field.name == 'estimasi_layanan' %}
							<div class="col-sm-10">
								<div class="row">
									<div class="col-sm-5">
		                      			{{ field }}
		                      		</div>
		                      		<div class="col-sm-1">
		                      			<p class="text-muted" class="label label-danger" style="margin-bottom:0;font-size:20px;margin-top:4px">Hari</p>
		                      		</div>
		                      	</div>
		                   	</div>
							{% else %}
		                   <div class="col-sm-10">
		                      {{ field }}
		                   </div>
		                   {% endif %}
		                </div>
		                
					{% endfor %}
					<input type="hidden" name="id" id="id">					
				</form>
			</div>
			<div class="modal-footer justify-content-between">
				<button type="button" class="btn btn-default" data-dismiss="modal">Tutup</button>
				<button type="button" class="btn btn-primary" id="updateButton">Update</button>
				<button type="button" class="btn btn-primary" id="createButton">Simpan</button>
			</div>
		</div>
		<!-- /.modal-content -->
	</div>
	<!-- /.modal-dialog -->
</div>
<!-- /.modal -->
{% endblock %}




{% block file_js %}
<!-- Bootstrap 4 -->
<script src="{% static 'assets/plugins/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
<!-- DataTables -->
<script src="{% static 'assets/plugins/datatables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'assets/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js' %}"></script>
<script src="{% static 'assets/plugins/datatables-responsive/js/dataTables.responsive.min.js' %}"></script>
<script src="{% static 'assets/plugins/datatables-responsive/js/responsive.bootstrap4.min.js' %}"></script>
<!-- SweetAlert2 -->
<script src="{% static 'assets/plugins/sweetalert2/sweetalert2.min.js' %}"></script>
<!-- ELIPSIS -->
<script src="{% static 'assets/plugins/dataRender/ellipsis.js' %}"></script>


<script>
	$(document).ready(function(){
 
		function getCookie(name) {
	        var cookieValue = null;
	        if (document.cookie && document.cookie != '') {
	            var cookies = document.cookie.split(';');
	            for (var i = 0; i < cookies.length; i++) {
	                var cookie = jQuery.trim(cookies[i]);
	                // Does this cookie string begin with the name we want?
	                if (cookie.substring(0, name.length + 1) == (name + '=')) {
	                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
	                    break;
	                }
	            }
	        }
	        return cookieValue;
	    }

		function tampilkan_pesan(pesan, type){
	    	Toast.fire({
	        icon: type,
	        title: pesan
	      });
	    }

		const Toast = Swal.mixin({
	      toast: true,
	      position: 'top-end',
	      showConfirmButton: false,
	      timer: 3000
	    });

		var table = $('#tabel-layanan').DataTable({
			"columns": [{
		            "width": "6%"
		        },
		        {
		            "width": "14%"
		        },
		        {
		            "width": "14%"
		        },
		        {
		            "width": "16%"
		        },
		        {
		            "width": "16%"
		        },
		        {
		            "width": "20%"
		        },
		    ],
		    "paging": true,
		    "searching": true,
		    "ordering": true,
		    "info": true,
		    "processing": true,
		    "serverside": true,
		    "ajax": {
		        "url": $("#createLayananForm").data('url'),
		        "type": "get"
		    },
		    "autoWidth": false,
		    "responsive": true,
		    "lengthChange": true,
		    "ordering": true,
		    "deferRender": true,
		    columnDefs: [{
		        targets: [3],
		        render: $.fn.dataTable.render.ellipsis( 17, true ),
		    }]
		});

		//CREATE DATA (SHOW FORM)
		$("#createLayanan").click(function(e){
			e.preventDefault();
			$("#createLayananForm")[0].reset();
			$("#createButton").prop("disabled", false);
			document.getElementById("updateButton").style.display = "none";
			document.getElementById("createButton").style.display = "block";
			document.getElementById("title_modal").innerHTML = "Tambah Data Layanan";

			$('#modal_layanan').modal('show');
			
		});


		// CREATE DATA ACTION
		$("#createButton").click(function(e){
			if (!$("#createLayananForm").valid()) return;

			e.preventDefault();
			$("#createButton").prop("disabled", true);
			var serializeData = $("#createLayananForm")[0];
			serializeData = new FormData(serializeData);
			
			$.ajax({
				url: $("#createLayananForm").data('url'),
				data: serializeData,
				type: 'post',
				cache: false,
				processData: false,
        		contentType: false,
				success: function(response){
					$('#modal_layanan').modal('hide');
					setTimeout(function(){
						table.ajax.reload();
						tampilkan_pesan(response.msg, response.type);
					}, 1000);
					$("#createButton").prop("disabled", false);
					$("#createLayananForm")[0].reset();
				},
				error: function(xhr, status, error){
					// $('#modal_Layanan').modal('hide');
					setTimeout(function(){
					var error_response = xhr.responseJSON;
						tampilkan_pesan(error_response.msg, error_response.type);
					}, 1000)
					$("#createButton").prop("disabled", false);
					
				},
			})
		});


		//DETAIL DATA
		$('body').on('click', '.DetailLayanan', function(event){
			event.preventDefault();
			$("#createLayananForm")[0].reset();
			var id_layanan = $(this).data("id");
			$("#createButton").prop("disabled", false);
			$("#updateButton").prop("disabled", false);
			$.ajax({
				url: $("#createLayananForm").data('url') + 'detail/',
				type: 'get',
				data: {
					csrfmiddlewaretoken: getCookie('csrftoken'),
			  		id: id_layanan
				},
				success: function(response){
					document.getElementById("id_nama_layanan").value = response.data.nama_layanan;
					document.getElementById("id_estimasi_layanan").value = response.data.estimasi_layanan;
					document.getElementById("id_deskripsi").value = response.data.deskripsi;

					document.getElementById("id_nama_layanan").disabled = true;
					document.getElementById("id_estimasi_layanan").disabled = true;
					document.getElementById("id_deskripsi").disabled = true;
					document.getElementById("updateButton").style.display = "none";
					document.getElementById("createButton").style.display = "none";
					document.getElementById("title_modal").innerHTML = "Detail Data Layanan";
					
					$('#modal_layanan').modal('show');
				}
			})
			
		});


		//BAGIAN DELETE
	    $('body').on('click', '.deleteLayanan', function () {
	        var id_layanan = $(this).data("id");
	        var nama_layanan = $(this).data("nama");
	        Swal.fire({
			  title: 'Anda yakin?',
			  text: "Yakin menghapus "+ nama_layanan +"!",
			  icon: 'warning',
			  showCancelButton: true,
			  confirmButtonColor: '#3085d6',
			  cancelButtonColor: '#d33',
			  confirmButtonText: 'Yes, delete it!',
			}).then((result)=>{
			  if (result.value) {
			  	$.ajax({
			  		url: $("#createLayananForm").data('url') + 'delete/',
			  		data: {
			  			csrfmiddlewaretoken: getCookie('csrftoken'),
			  			id: id_layanan
			  		},
			  		type: 'post',
			  		dataType: 'json',
			  		success: function(response){
			  			tampilkan_pesan(response.msg, response.type);
			  			table.ajax.reload();
			  		},
			  		error: function(xhr, status, error){
			  			var error_response = xhr.responseJSON;
			  			tampilkan_pesan(error_response.msg, error_response.type);
			  		}
			  	});
			    
			  }
			})
	    });


	    //EDIT DATA SHOW
		$('body').on('click', '.editLayanan', function(event){
			event.preventDefault();
			$("#createLayananForm")[0].reset();
			$("#updateButton").prop("disabled", false);
			var id_layanan = $(this).data("id");

			$.ajax({
				url: $("#createLayananForm").data('url') + 'detail/',
				type: 'get',
				data: {
					csrfmiddlewaretoken: getCookie('csrftoken'),
			  		id: id_layanan
				},
				success: function(response){
					document.getElementById("id").value = response.data.id;
					document.getElementById("id_nama_layanan").value = response.data.nama_layanan;
					document.getElementById("id_estimasi_layanan").value = response.data.estimasi_layanan;
					document.getElementById("id_deskripsi").value = response.data.deskripsi;
					document.getElementById("id_publish_status").checked = response.data.publish_status;

					document.getElementById("id_nama_layanan").disabled = false;
					document.getElementById("id_estimasi_layanan").disabled = false;
					document.getElementById("id_deskripsi").disabled = false;
					document.getElementById("id_publish_status").disabled = false;

					document.getElementById("updateButton").style.display = "block";
					document.getElementById("createButton").style.display = "none";
					document.getElementById("title_modal").innerHTML = "Edit Data Layanan";
					
					$('#modal_layanan').modal('show');
				}
			})
			
		});


		// Update action
		$("#updateButton").click(function(e){
			e.preventDefault();
			$("#updateButton").prop("disabled", true);
			var serializeData = $("#createLayananForm").serialize();
			
			$.ajax({
				url: $("#createLayananForm").data('url') + 'update/',
				data: serializeData,
				type: 'post',
				cache: false,
				success: function(response){
					table.ajax.reload();
					$('#modal_layanan').modal('hide');
					tampilkan_pesan(response.msg, response.type);
					$("#createLayananForm")[0].reset();
					$("#updateButton").prop("disabled", false);
					
				},
				error: function(xhr, status, error){
					var error_response = xhr.responseJSON;
					tampilkan_pesan(error_response.msg, error_response.type);
					$("#updateButton").prop("disabled", false);
				},
			})

			
		});


		$(document).on('hide.bs.modal','.modal', function () {
		  setTimeout(function(){
				var validator = $("#createLayananForm").validate();
				validator.resetForm();
			
			},1000)
		})


	});

</script>
{% endblock %}
