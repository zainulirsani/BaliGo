{% extends 'base.html' %}
{% load static %}

{% block title_name %}
 <title>Personil | BaliGo Ekspedisi</title>
{% endblock %}

{% block file_css %}
<!-- DataTables -->
 <link rel="stylesheet" href="{% static 'assets/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css' %}">
 <link rel="stylesheet" href="{% static 'assets/plugins/datatables-responsive/css/responsive.bootstrap4.min.css' %}">
 <!-- SweetAlert2 -->
  <link rel="stylesheet" href="{% static 'assets/plugins/sweetalert2-theme-bootstrap-4/bootstrap-4.min.css' %}">

   <!-- Select2 -->
  <link rel="stylesheet" href="{% static 'assets/plugins/select2/css/select2.min.css' %}">
  <link rel="stylesheet" href="{% static 'assets/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css' %}">
{% endblock %}


{% block content_header %}
<div class="container-fluid">
	<div class="row mb-2">
		<div class="col-sm-6">
			<h1 class="m-0 text-dark">Personil</h1>
		</div><!-- /.col -->
		<div class="col-sm-6">
			<ol class="breadcrumb float-sm-right">
				<li class="breadcrumb-item"><a href="#">Home</a></li>
				<li class="breadcrumb-item active">Personil</li>
			</ol>
		</div><!-- /.col -->
	</div><!-- /.row -->
</div><!-- /.container-fluid -->
{% endblock %}



{% block content %}
<div class="card">
	<div class="card-header">
		<h3 class="card-title">Data Personil</h3>
		<div class="card-tools">
			<button type="button" class="btn btn-block bg-gradient-primary" id="createPersonil">
			<i class="fa fa-plus"></i>&nbsp; Tambah Personil
			</button>
		</div>
	</div>
	<!-- /.card-header -->
	<div class="card-body">	
		<table id="personil" class="table table-bordered table-striped">
			<thead>
				<tr>
					<th>No</th>
					<th>ID Personil</th>
					<th>Nama</th>
					<th>Email</th>
					<th>No. Tlp</th>
					<th>Role</th>
					<th>Action</th>
				</tr>
			</thead>
			<tbody>
				
			</tbody>
			<tfoot>
			<tr>
				<th>No</th>
				<th>ID Personil</th>
				<th>Nama</th>
				<th>Email</th>
				<th>No. Tlp</th>
				<th>Role</th>
				<th>Action</th>
			</tr>
			</tfoot>
		</table>
	</div>
	<!-- /.card-body -->
</div>


<!-- /.modal -->
<div class="modal fade" id="modal_personil_detail">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title" id="title_modal">Detail Data Personil</h4>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
				<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<div class="form-group row">
					<label for="id_no_personil" class="col-sm-2 col-form-label">ID Personil</label>
					<div class="col-sm-10">
						<input class="form-control" type="text" name="" id="id_no_personil" disabled="">
					</div>
				</div>

				{% for field in form_personil %}
					{% if not field.name == 'photo' and not field.name == 'penempatan_toko' and not field.name == 'penempatan_gudang' and not field.name == 'password' and not 	field.name == 're_password' and not field.name == 'no_personil' %}
					<div class="form-group row">
						<label for="{{ field.name }}" class="col-sm-2 col-form-label">{{ field.label }}</label>
						<div class="col-sm-10">
						  {{ field }}
						</div>
					</div>
					{% endif %}
				{% endfor %}
				<div class="form-group row photo">
					<label for="photo" class="col-sm-2 col-form-label">Penempatan</label>
					<div class="col-sm-10">
						<input type="text" class="form-control" id="id_penempatan" disabled="">
					</div>
				</div>
				<div class="form-group row photo">
					<label for="photo" class="col-sm-2 col-form-label">Foto Identitas</label>
					<div class="col-sm-10">
						<div class="drop">
							<div class="uploader">
							  <label class="drop-label">Preview Foto Disini</label>
							</div>
							<div class="image-preview"></div>
						</div>
					</div>
				</div>
			</div>
			<div class="modal-footer justify-content-between">
				<button type="button" class="btn btn-default" data-dismiss="modal">Tutup</button>
			</div>
		</div>
		<!-- /.modal-content -->
	</div>
	<!-- /.modal-dialog -->
</div>
<!-- /.modal -->


<!-- /.modal -->
<div class="modal fade" id="modal_personil">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title" id="title_modal">Tambah Data Personil</h4>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
				<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<form id="createPersonilForm" enctype="multipart/form-data" method="post" data-url="{% url 'personil' %}" data-url_api_gudang="{% url 'gudang_select2' %}" data-url_api_toko="{% url 'toko_select2' %}" data-url_activated="{% url 'personil_activated'%}">
					{% csrf_token %}
					{% for field in form_personil %}
						{% if not field.name == 'photo' and not field.name == 'no_personil' %}
						<div class="form-group row {{ field.name }}" {% if field.name == 'penempatan_toko' or field.name == 'penempatan_gudang' %} hidden {% endif %}>
							<label for="{{ field.name }}" class="col-sm-2 col-form-label">{{ field.label }}</label>
							<div class="col-sm-10">
							  {{ field }}
							</div>
						</div>
						{% endif %}
					{% endfor %}
					<div id="edit_html"></div>
					<div class="form-group row photo">
						<label for="photo" class="col-sm-2 col-form-label">Foto Identitas</label>
						<div class="col-sm-10">
							<div class="drop">
								<div class="uploader">
								  <label class="drop-label">Drag & Drop Foto Disini</label>
						  		  <input type="file" class="image-upload" name="photo" accept="image/*" id="id_photo">
								</div>
								<div id="image-preview"></div>
							</div>
						</div>
					</div>
					<input type="hidden" name="id" id="id">
				</form>
			</div>
			<div class="modal-footer justify-content-between">
				<button type="button" class="btn btn-default" data-dismiss="modal">Tutup</button>
				<button type="button" class="btn btn-primary" id="updateButton">Update</button>
				<button type="button" class="btn btn-primary" id="createButton">Simpan</button>
			</div>
		</div>
		<!-- /.modal-content -->
	</div>
	<!-- /.modal-dialog -->
</div>
<!-- /.modal -->



{% endblock %}
{% block file_js %}
<!-- Bootstrap 4 -->
<script src="{% static 'assets/plugins/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
<!-- DataTables -->
<script src="{% static 'assets/plugins/datatables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'assets/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js' %}"></script>
<script src="{% static 'assets/plugins/datatables-responsive/js/dataTables.responsive.min.js' %}"></script>
<script src="{% static 'assets/plugins/datatables-responsive/js/responsive.bootstrap4.min.js' %}"></script>
<!-- SweetAlert2 -->
<script src="{% static 'assets/plugins/sweetalert2/sweetalert2.min.js' %}"></script>
<!-- Select2 -->
<script src="{% static 'assets/plugins/select2/js/select2.full.min.js' %}"></script>
<script>
	$(document).ready(function(){
		var url_edit = '';

		function getCookie(name) {
		    var cookieValue = null;
		    if (document.cookie && document.cookie != '') {
		        var cookies = document.cookie.split(';');
		        for (var i = 0; i < cookies.length; i++) {
		            var cookie = jQuery.trim(cookies[i]);
		            // Does this cookie string begin with the name we want?
		            if (cookie.substring(0, name.length + 1) == (name + '=')) {
		                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
		                break;
		            }
		        }
		    }
		    return cookieValue;
		}

		function tampilkan_pesan(pesan, type){
			Toast.fire({
			icon: type,
			title: pesan
		  });
		}

		$(function() {
		    $("input[name='no_telp']").on('input', function(e) {
		        $(this).val($(this).val().replace(/[^0-9]/g, ''));
		    });
		});


		$('#id_penempatan_gudang').select2({
    		allowClear: true,
			ajax: {
		        url: $("#createPersonilForm").data('url_api_gudang'),
		        dataType: "json",
		        type: "GET",
        		delay: 250,
        		cache: false,
		        data: function (params) {
		            return {
		            	q: params.term,
		            	page: params.page || 1,
		        	}
		        },
		        processResults: function(data, params) {
		            var page = params.page || 1;
		            return {
		                results: $.map(data.results, function (item) { return {id: item.id, text: item.text}}),
		                pagination: {
		                    more: data.total_count >= (page * 10) 
		                }
		            };
		        },
			},
	        theme: 'bootstrap4',
	        placeholder: 'Pilih Gudang',
	        language: "id",

	    });

	    $('#id_penempatan_toko').select2({
	    	allowClear: true,
			ajax: {
		        url: $("#createPersonilForm").data('url_api_toko'),
		        dataType: "json",
		        type: "GET",
        		delay: 250,
        		cache: false,
		        data: function (params) {
		            return {
		            	q: params.term,
		            	page: params.page || 1,
		        	}
		        },
		        processResults: function(data, params) {
		            var page = params.page || 1;
		            return {
		                results: $.map(data.results, function (item) { return {id: item.id, text: item.text}}),
		                pagination: {
		                    more: data.total_count >= (page * 10) 
		                }
		            };
		        },
			},
	        theme: 'bootstrap4',
	        placeholder: 'Pilih Outlet',
	        language: "id",
	    });

		const Toast = Swal.mixin({
		  toast: true,
		  position: 'top-end',
		  showConfirmButton: false,
		  timer: 4000
		});

		var table = $('#personil').DataTable({
		    "columns": [{
		            "width": "6%"
		        },
		        {
		            "width": "12%"
		        },
		        {
		            "width": "12%"
		        },
		        null,
		        null,
		        null, {
		            "width": "24%"
		        },
		    ],
		    "paging": true,
		    "lengthChange": false,
		    "searching": true,
		    "ordering": true,
		    "info": true,
		    "autoWidth": false,
		    "responsive": true,
		    "processing": true,
		    "serverside": true,
		    "ajax": {
		        "url": $("#createPersonilForm").data('url'),
		        "type": "GET"
		    },
		    "deferRender": true,
		});

		
		function disable_button_when_not_changes(response) {

		    let input_1 = $('#modal_personil #id_first_name');
		    let input_2 = $('#modal_personil #id_no_telp');
		    let input_3 = $('#modal_personil #id_alamat');
		    let input_4 = $('#modal_personil #id_role');
		    let input_5 = $('#modal_personil #id_penempatan_toko');
		    let input_6 = $('#modal_personil #id_penempatan_gudang');
		    let input_7 = $('#modal_personil #id_password');
		    let input_8 = $('#modal_personil #re_password');
		    let input_9 = $('#modal_personil #id_photo');

		    var html_image_preview = document.getElementById("image-preview").innerHTML;

		    let button = document.getElementById("updateButton");
		    button.disabled = true;
		    input_1.addEventListener("keyup", stateHandle);
		    input_2.addEventListener("keyup", stateHandle);
		    input_3.addEventListener("keyup", stateHandle);
		    input_4.addEventListener("change", stateHandle);
		    input_5.addEventListener("change", stateHandle);
		    input_6.addEventListener("change", stateHandle);
		    input_7.addEventListener("keyup", stateHandle);
		    input_8.addEventListener("keyup", stateHandle);
		    input_8.addEventListener("change", stateHandle);


		    function stateHandle() {
		        if (
		        	document.getElementById("id_first_name").value == response.data.first_name &&
		        	document.getElementById("id_no_telp").value == response.data.no_telp &&
		        	document.getElementById("id_alamat").value == response.data.alamat &&
		        	document.getElementById("id_role").value == response.data.role &&
		        	document.getElementById("id_penempatan_toko").value == response.data.penempatan_toko_id &&
		        	document.getElementById("id_penempatan_gudang").value == response.data.penempatan_gudang_id &&
		        	document.getElementById("id_password").value != '' &&
		        	document.getElementById("re_password").value != '' &&
		        	document.getElementById("image-preview").innerHTML == html_image_preview
		        	) {
		            button.disabled = true;
		        } else {
		            button.disabled = false;
		        }
		    }
		}


		$(document).on('change', '#modal_personil #id_role',function(e){
			var $_value = this.value || null;
			if($_value == 'adm_gudang') {
				$('.penempatan_toko').attr('hidden') ? '' : $('.penempatan_toko').attr('hidden', "");
				$('.penempatan_gudang').removeAttr('hidden');
				$('.penempatan_toko select').prop('required', false);
				$('.penempatan_gudang select').val('');
				$('.penempatan_gudang select').prop('required', true);


			}
			else if($_value == 'adm_outlet' || $_value == 'kurir'){
				$('.penempatan_gudang').attr('hidden') ? '' : $('.penempatan_gudang').attr('hidden', "");
				$('.penempatan_toko').removeAttr('hidden');
				$('.penempatan_gudang select').prop('required', false);
				$('.penempatan_toko select').val('');
				$('.penempatan_toko select').prop('required', true);
			}
			else {
				$('.penempatan_toko').prop('hidden', true);
				$('.penempatan_gudang').prop('hidden', true);
				$('.penempatan_toko select').prop('required', false);
				$('.penempatan_gudang select').prop('required', false);
			}

		});


		//CREATE DATA (SHOW FORM)
		$("#createPersonil").click(function(e) {
		    e.preventDefault();
		    $("#createPersonilForm")[0].reset();
		    document.getElementById("updateButton").style.display = "none";
		    document.getElementById("createButton").style.display = "block";
		    $('#modal_personil #title_modal').html("Tambah Data Personil");
		    $('#id_penempatan_toko').innerHTML = '';
		    $('#id_penempatan_gudang').innerHTML = '';
		    $('#id_penempatan_gudang').val(null).trigger('change');
		    $('#id_penempatan_toko').val(null).trigger('change');
		    $('#modal_personil #id_username').prop('disabled', false);
		    $('#modal_personil #id_email').prop('disabled', false);
		    $('#modal_personil #id_password').prop('placeholder', 'Tentukan Password Anda');
		    $('#modal_personil #re_password').prop('placeholder', 'Masukan ulang password');

		    $('#modal_personil').modal('show');

		});

		

		// CREATE DATA ACTION
		$("#createButton").click(function(e){
			if (!$("#createPersonilForm").valid()) return;

			e.preventDefault();
			 $("#createButton").prop("disabled", true);
			var serializeData = $("#createPersonilForm")[0];
			serializeData = new FormData(serializeData);
			
			$.ajax({
				url: $("#createPersonilForm").data('url'),
				data: serializeData,
				type: 'post',
				cache: false,
				processData: false,
        		contentType: false,
				success: function(response){
					$('#modal_personil').modal('hide');
					setTimeout(function(){
						if(response.arsip == true){
							show_activated(response);
						}else{
							table.ajax.reload();
							tampilkan_pesan(response.msg, response.type);
						}
						
					}, 1000);
					$("#createPersonilForm")[0].reset();
					$("#createButton").prop("disabled", false);
					
				},
		        error: function(xhr, status, error) {
		            // $('#modal_personil').modal('hide');
		            setTimeout(function() {
		                var error_response = xhr.responseJSON;
		                if (error_response.arsip == true) {
		                    show_activated(response);
		                }else{
		                	tampilkan_pesan(error_response.msg, error_response.type);
		                }
		            }, 1000);
		            $("#createButton").prop("disabled", false);
		            
		        },
			})
		});

		function getBase64(file) {
		  return new Promise((resolve, reject) => {
		    const reader = new FileReader();
		    reader.readAsDataURL(file);
		    reader.onload = () => resolve(reader.result);
		    reader.onerror = error => reject(error);
		  });
		}

		//DETAIL DATA
		$('body').on('click', '.detailPersonil', function(event) {
		    event.preventDefault();
		    var id_personil = $(this).data("id");
		    $('#id_penempatan_toko').innerHTML = '';
			$('#id_penempatan_gudang').innerHTML = '';
		    var tokoSelect = $('#modal_personil_detail #id_penempatan_toko');
		    var gudangSelect = $('#modal_personil_detail #id_penempatan_gudang');
		    $.ajax({
		        url: $("#createPersonilForm").data('url') + 'detail/',
		        data: {
		        	csrfmiddlewaretoken: getCookie('csrftoken'),
					id: id_personil
		        },
		        type: 'get',
		        success: function(response) {
		            console.log(response)
		            try {
		                // Populate data from response
		                const {
		                    alamat,
		                    no_personil,
		                    email,
		                    first_name,
		                    no_telp,
		                    penempatan_toko,
		                    penempatan_toko_id,
		                    penempatan_gudang,
		                    penempatan_gudang_id,
		                    photo,
		                    role,
		                    username
		                } = response.data || null

		                var penempatan = penempatan_toko || penempatan_gudang

		                $('#modal_personil_detail select > option').each(function(i, el) {
		                    if (el.value.trim() == role)
		                        $('#modal_personil_detail select#id_role')[0].selectedIndex = i;
		                });

		                // Disable all input
		                $('#modal_personil_detail input').prop('disabled', true);
		                $('#modal_personil_detail select').prop('disabled', true);
		                $('#modal_personil_detail textarea').prop('disabled', true);


		                $('#modal_personil_detail #id_no_personil').val(no_personil);
		                if (photo)
		                    $('#modal_personil_detail .image-preview').append(`<img src=${photo}>`);
		                $('#modal_personil_detail #id_first_name').val(first_name);
		                $('#modal_personil_detail #id_email').val(email);
		                $('#modal_personil_detail #id_no_telp').val(no_telp);
		                $('#modal_personil_detail #id_penempatan').val(penempatan);
		                $('#modal_personil_detail #id_username').val(username);
		                $('#modal_personil_detail #id_alamat').text(alamat);

		                //Show data select2
		                var option_toko = new Option(penempatan_toko, penempatan_toko_id, true, true);
    					tokoSelect.append(option_toko).trigger('change');

    					var option_gudang = new Option(penempatan_gudang, penempatan_gudang_id, true, true);
    					gudangSelect.append(option_gudang).trigger('change');

		                $('#modal_personil_detail').modal('show');
		            } catch (e) {
		                tampilkan_pesan(e, 'error')
		            }
		        },
		        error: function(xhr, status, error) {
		            var error_response = xhr.responseJSON;
		            tampilkan_pesan(error_response.msg, error_response.type);
		        }
		    })

		});

		//EDIT DATA SHOW
		$('body').on('click', '.editPersonil', function(event){
			event.preventDefault();
			$('#modal_personil #id_password').prop('required', false)
			$('#modal_personil #re_password').prop('required', false)
			$('#modal_personil #title_modal').html("Update Data Personil");
			$('#id_penempatan_toko').innerHTML = '';
			$('#id_penempatan_gudang').innerHTML = '';
			var tokoSelect = $('#modal_personil #id_penempatan_toko');
		    var gudangSelect = $('#modal_personil #id_penempatan_gudang');

			var id_personil = $(this).data("id");
			$.ajax({
				url: $("#createPersonilForm").data('url') + 'detail/',
				data: {
					csrfmiddlewaretoken: getCookie('csrftoken'),
					id: id_personil
				},
				type: 'get',
				success: function(response){
					// disable_button_when_not_changes(response);
					try {
						// Populate data from response
						const {
							id,
							alamat,
							no_personil,
							email,
							first_name,
							no_telp,
							penempatan,
							photo,
							role,
							username,
							penempatan_toko,
							penempatan_toko_id,
							penempatan_gudang,
							penempatan_gudang_id
						} = response.data || null


						$('#modal_personil select > option').each(function(i, el){
							if(el.value.trim() == role) {
								$('#modal_personil select#id_role')[0].selectedIndex = i;
								if(el.value.trim() == 'adm_outlet') {
									$('.penempatan_toko').prop('hidden', false);
									$('.penempatan_gudang').prop('hidden', true);
									$('#modal_personil #id_penempatan_toko > option').each(function(i, el){
										if(el.value == penempatan_toko_id)
											$('#modal_personil #id_penempatan_toko')[0].selectedIndex = i;
									});
								}
								else if(el.value.trim() == 'adm_gudang') {
									$('.penempatan_toko').prop('hidden', true);
									$('.penempatan_gudang').prop('hidden', false);
									$('#modal_personil #id_penempatan_gudang > option').each(function(i, el){
										if(el.value == penempatan_gudang_id)
											$('#modal_personil #id_penempatan_gudang')[0].selectedIndex = i;

									});
								}
								else {
									$('.penempatan_toko').prop('hidden', true);
									$('.penempatan_gudang').prop('hidden', false);
								}

							}
						});

						$('#modal_personil #id_no_personil').val(no_personil);
						if(photo)
							$('#modal_personil #image-preview').append(`<img src=${photo}>`);
						$('#modal_personil #id_first_name').val(first_name);
						$('#modal_personil #id_email').val(email);
						$('#modal_personil #id_no_telp').val(no_telp);
						$('#modal_personil #id_username').val(username);
						$('#modal_personil #id_alamat').val(alamat);
						try{
							document.getElementById("updateButton").style.display = "block";
							document.getElementById("createButton").style.display = "none";
							$('#modal_personil #id_username').prop('disabled', true);
							$('#modal_personil #id_email').prop('disabled', true);
							$('#modal_personil #id_password').prop('placeholder', 'Kosongkan jika tidak ingin mengganti password');
							$('#modal_personil #re_password').prop('placeholder', 'Kosongkan jika tidak ingin mengganti password');

							document.getElementById("id").value = id;
							document.getElementById("edit_html").innerHTML = '<input type="hidden" name="no_personil" value="'+ no_personil +'">';
						} catch(e) { console.log(e) }

						//Show data select2
		                if (role == 'adm_gudang') {
		                    // var option_toko = new Option(null, null, true, true);
		                    // tokoSelect.append(option_toko).trigger('change');

		                    var option_gudang = new Option(penempatan_gudang, penempatan_gudang_id, true, true);
		                    gudangSelect.append(option_gudang).trigger('change');
		                } else if (role == 'adm_outlet') {
		                    var option_toko = new Option(penempatan_toko, penempatan_toko_id, true, true);
		                    tokoSelect.append(option_toko).trigger('change');

		                    // var option_gudang = new Option(null, null, true, true);
		                    // gudangSelect.append(option_gudang).trigger('change');
		                } else {
		                    var option_toko = new Option(null, null, true, true);
		                    tokoSelect.append(option_toko).trigger('change');

		                    var option_gudang = new Option(null, null, true, true);
		                    gudangSelect.append(option_gudang).trigger('change');
		                }


						$('#modal_personil').modal('show');
					} catch(e) { tampilkan_pesan(e, 'error') }
				},
				error: function(xhr, status, error){
					var error_response = xhr.responseJSON;
					tampilkan_pesan(error_response.msg, error_response.type);
				}
			})
			
		});

		// Update action
		$("#updateButton").click(function(e){
			if (!$("#createPersonilForm").valid()) return;

			e.preventDefault();
			$("#updateButton").prop("disabled", true);
			var serializeData = $("form#createPersonilForm")[0];
			serializeData = new FormData(serializeData);
			serializeData.append('csrfmiddlewaretoken', getCookie('csrftoken'))

			$.ajax({
				url: $("#createPersonilForm").data('url') + 'update/',
				data: serializeData,
				type: 'post',
				cache: false,
				processData: false,
        		contentType: false,
				success: function(response){
					table.ajax.reload();
					$('#modal_personil').modal('hide');
					tampilkan_pesan(response.msg, response.type);
					$("#createPersonilForm")[0].reset();
					$("#updateButton").prop("disabled", false);
				},
				error: function(xhr, status, error){
					console.log(xhr)
					var error_response = xhr.responseJSON;
					tampilkan_pesan(error_response.msg, error_response.type);
					$("#updateButton").prop("disabled", false);
				},
			}); 

		});

		function show_activated(data_response){
			var id_personil = data_response.personil.id;
			var username = data_response.personil.username;
			var email = data_response.personil.email;

			Swal.fire({
			  title: 'Restore Personil',
			  text: "Ingin Merestore Personil dengan Email: "+ email +"!",
			  icon: 'warning',
			  showCancelButton: true,
			  confirmButtonColor: '#3085d6',
			  cancelButtonColor: '#d33',
			  confirmButtonText: 'Ya, Aktifkan Kembali!',
			  cancelButtonText: 'Tidak, Terimakasih!',
			}).then((result)=>{
			  if (result.value) {
				$.ajax({
					url: $("#createPersonilForm").data('url_activated'),
					data: {
						csrfmiddlewaretoken: getCookie('csrftoken'),
						id: id_personil
					},
					type: 'post',
					dataType: 'json',
					success: function(response){
						tampilkan_pesan(response.msg, response.type);
						table.ajax.reload();
					},
					error: function(xhr, status, error){
						var error_response = xhr.responseJSON;
						tampilkan_pesan(error_response.msg, error_response.type);
					}
				});
				
			  }
			})
		}
	   //BAGIAN DELETE
		$('body').on('click', '.deletePersonil', function () {
			var id_personil = $(this).data("id");
			var nama_personil = $(this).data("nama");
			Swal.fire({
			  title: 'Anda yakin?',
			  text: "Yakin menghapus "+ nama_personil +"!",
			  icon: 'warning',
			  showCancelButton: true,
			  confirmButtonColor: '#3085d6',
			  cancelButtonColor: '#d33',
			  confirmButtonText: 'Yes, delete it!',
			}).then((result)=>{
			  if (result.value) {
				$.ajax({
					url: $("#createPersonilForm").data('url') + 'delete/',
					data: {
						csrfmiddlewaretoken: getCookie('csrftoken'),
						id: id_personil
					},
					type: 'post',
					dataType: 'json',
					success: function(response){
						tampilkan_pesan(response.msg, response.type);
						table.ajax.reload();
					},
					error: function(xhr, status, error){
						var error_response = xhr.responseJSON;
						tampilkan_pesan(error_response.msg, error_response.type);
					}
				});
				
			  }
			})
		});


		function clearValidation(formElement){
		 //Internal $.validator is exposed through $(form).validate()
		 var validator = $(formElement).validate();
		 //Iterate through named elements inside of the form, and mark them as error free
		 $('[name]',formElement).each(function(){
		   try {
		   	console.log(this.name)
		   	this.name == 'alamat' ? ($(this).val(''), $(this).text('')) : $(this).val('');
		   	$(this).not('#id_photo').prop('required', true)
		   } catch(e){ console.log(e) }
		   validator.successList.push(this);//mark as error free
		   validator.showErrors();//remove error messages if present
		 });
		 validator.resetForm();//remove error class on name elements and clear history
		 validator.reset();//remove all error and success data
		}

		$('#modal_personil').on('hide.bs.modal', function(){
			setTimeout(function(){
				try{
					$('#modal_personil #title_modal').html("Tambah Data Personil")
					document.getElementById("updateButton").style.display = "none";
					document.getElementById("createButton").style.display = "block";
				} catch(e) { console.log(e) }
				$('#modal_personil .penempatan_gudang').prop('hidden', true);
				$('#modal_personil .penempatan_toko').prop('hidden', true);
				$('#modal_personil #id_photo').val('');
				$('#modal_personil #image-preview').html('');
				try {
					var form = document.getElementById('createPersonilForm');
					clearValidation(form)
				} catch(e) {
					console.log(e)
				}
			})
		});

		$('#modal_personil_detail').on('hide.bs.modal', function(){
			setTimeout(function(){
				$('#modal_personil_detail .image-preview').html('')
			})
		});

		$('#id_photo').imageReader();
	});
</script>
{% endblock %}
