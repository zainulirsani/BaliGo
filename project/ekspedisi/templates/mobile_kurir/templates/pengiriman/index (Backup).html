{% extends '../base.html' %}
{% load static %}
{% load custom_filter %}

{% block title_name %}
 <title>Pengiriman | BaliGo Ekspedisi</title>
{% endblock %}



{% block file_css %}
<!-- Daterange picker -->
<link rel="stylesheet" href="{% static 'assets/plugins/daterangepicker/daterangepicker.css' %}">
<!-- summernote -->
<link rel="stylesheet" href="{% static 'assets/plugins/summernote/summernote-bs4.css' %}">
<link rel="stylesheet" href="{% static 'assets/plugins/sweetalert2/sweetalert2.min.css' %}">
<style>
  #preview,
  #preview-sampai{
     width:100%;
     height: auto;
     margin:0px auto;
  }
</style>
{% endblock %}

{% block breadcrumb_mobile %}
  Pengiriman
{% endblock breadcrumb_mobile %}


{% block content %}
<div class="modal fade" id="modal-scanner">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="title_modal"><i class="fas fa-qrcode"></i>&nbsp;&nbsp;Scan Kirim</h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
        <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="scanner-body-kirim">
        <video id="preview"></video>
      </div>
      <div class="modal-footer justify-content-between">
        <button type="button" class="btn btn-default" data-dismiss="modal">Tutup</button>
        
      </div>
    </div>
    <!-- /.modal-content -->
  </div>
  <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal-scanner-sampai">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="title_modal"><i class="fas fa-qrcode"></i>&nbsp;&nbsp;Scan Sampai</h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
        <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="scanner-body-sampai">
        <video id="preview-sampai"></video>
      </div>
      <div class="modal-footer justify-content-between">
        <button type="button" class="btn btn-default" data-dismiss="modal">Tutup</button>
        
      </div>
    </div>
    <!-- /.modal-content -->
  </div>
  <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="card mb-4 card-title-sticky">
  {% csrf_token %}
  <div class="card-header">
    <div class="card-tools">
      <ul class="nav nav-pills ml-auto p-2">
        <li class="nav-item"><a class="nav-link active" href="#tab_menunggu" data-toggle="tab"><i class="nav-icon fas fa-plane"></i>&emsp;Kirim</a></li>
        <li class="nav-item"><a class="nav-link" href="#tab_berhasil" data-toggle="tab"><i class="nav-icon fas fa-check-square"></i>&emsp;Sampai</a></li>
        <li class="nav-item"><a class="nav-link" href="#tab_history" data-toggle="tab"><i class="nav-icon fas fa-history"></i>&emsp;History Scan</a></li>
      </ul>
    </div>
  </div>
</div>

<div class="card">
  <!-- /.card-header -->
  <div class="card-body">
    <!-- ANY MESSAGE GOES HERE -->
    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    {% endfor %}
    {% endif %}
    <!-- END MESSAGE -->
    <div class="tab-content">
      <div class="tab-pane active" id="tab_menunggu">
        <div class="card">
          <div class="offset-lg-2 offset-md-2 col-lg-8 col-md-8">
          <div class="input-group input-group-sm pt-2 pb-2">
            <div class="input-group-prepend">
            <select class="form-control search-mobile">
              <option>Resi</option>
              <option>Nama Cust</option>
              <option>No Telp</option>
            </select>
            </div>
            <!-- /btn-group -->
            <input type="text" placeholder="Pencarian Data...." class="form-control">
            <a class="btn bg-secondary text-white btn-sm barcode-group no-border-radius"><i class="fas fa-search"></i></a>
            <a class="btn btn-primary text-white btn-sm barcode-group"><i class="fas fa-qrcode"></i></a>
          </div>
          </div>
        </div>

        {% if pengiriman|length %}
          {% for kirim in pengiriman %}
            <!-- ISI DATA TABLE LIST OUTLET/TOKO -->
            <div class="card card-widget widget-user-2 shadow">
              {% comment %}
              <div class="quick-access-mobile">
              <div class="btn-group">
                <button type="button" class="btn btn-default btn-flat" data-toggle="dropdown"><i class="fas fa-ellipsis-h"></i>
                  <span class="sr-only">Toggle Dropdown</span>
                  <div class="dropdown-menu" role="menu">
                  <a class="dropdown-item" href="#">Konfirmasi Kirim</a>
                  </div>
                </button>
              </div>
              </div>
              {% endcomment %}
              <div class="widget-user-header bg-secondary">
              <!-- /.widget-user-image -->
              {{ kirim|get_log:kirim.id|safe }}
              <h3 class="widget-user-username">{{ kirim.id_pengiriman }}</h3>
              </div>
              <div class="card-footer p-0">
              <ul class="nav flex-column">
                <li class="nav-item">
                <span class="nav-link text-muted">
                  <i class="fas fa-user-circle"></i>{{ kirim.nama_pengirim }}
                </span>
                </li>
                <li class="nav-item">
                <span class="nav-link text-muted">
                  <i class="fas fa-phone-alt"></i>{{ kirim.no_telp_pengirim }}
                </span>
                </li>
                <li class="nav-item">
                <span class="nav-link text-muted">
                  <i class="fas fa-map-marker-alt"></i>{{ kirim.alamat_pengirim }}
                </span>
                </li>
              </ul>
              </div>
              <div>
              <div class="btn-wrapper">
                {% url 'kurir_pengiriman_detail' kirim.id as pengiriman_detail %}
                <a href="{{ pengiriman_detail }}" class="btn btn-sm btn-block btn-danger text-white"><i class="fas fa-eye"></i>&nbsp;&nbsp;Lihat Detail Pengiriman</a>
              </div>
              </div>
            </div>
            <hr>
          {% endfor %}
        {% else %}
          <div class="text-center">TIDAK ADA DATA</div>
        {% endif %}
      </div>
      <!-- /.tab-pane -->
      <div class="tab-pane" id="tab_berhasil">
        <!-- ISI DATA TABLE LIST GUDANG -->
          <div class="mb-2 text-center">
            <h5 class="mb-0 text-center text-muted">Arahkan resi pada scanner</h5>
            <small class="text-muted">* Upload data dapat dilakukan sekaligus</small>
          </div>
          <div id="scanner-wrapper-sampai" class="mb-2">
            <video id="scanner-sampai" class="scanner-show shadow"></video>
          </div>
          <form method="POST" id="form-upload-scan">
            {% csrf_token %}
            <input type="hidden" name="id_kurir" value="{{ request.user.id }}">
            <div id="table-scan-sampai">
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th>No Resi</th>
                    <th>Waktu Scan</th>
                  </tr>
                </thead>
                <tbody id="scan-data">
                  <tr>
                    <td colspan="4" class="text-center">Tidak ada data</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="mb-2">
              <button type="submit" disabled class="btn btn-primary btn-block text-white btn-upload-all-scan"><i class="fas fa-paper-plane"></i>&nbsp;&nbsp;Upload Data</button>
            </div>
          </form>
      </div>
      <div class="tab-pane" id="tab_history">
        <!-- ISI DATA TABLE LIST GUDANG -->
        {% if log_pengiriman|length %}
          <table id="table-history" class="table table-bordered table-stripped">
            <thead>
              <tr>
                <th>Tanggal</th>
                <th>Jenis Scan</th>
                <th>Discan Oleh</th>
              </tr>
            </thead>
            <tbody>
              {% for data in log_pengiriman %}
                <tr class="text-center">
                  <td>{{ data.created_at|date:'d-m-Y H:i:s' }}</td>
                  <td>{{ data.status_pengiriman|upper }}</td>
                  <td>Anda</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
        <div class="text-center">
          TIDAK ADA DATA
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  <!-- /.card-body -->
</div>
{% endblock %}

{% block file_js %}
<!-- ChartJS -->
<script src="{% static 'custom_js/qr_scan.js' %}"></script>
<script src="{% static 'assets/plugins/sweetalert2/sweetalert2.min.js' %}"></script>
<script type="text/javascript">
  $(function(){

    const Toast = Swal.mixin({
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 3000
    });

    function tampilkan_pesan(pesan, type) {
        Toast.fire({
            icon: type,
            title: pesan
        });
    }

    Number.prototype.padLeft = function(base,chr){
      var  len = (String(base || 10).length - String(this).length)+1;
      return len > 0? new Array(len).join(chr || '0')+this : this;
    }

    var scanner = {};
    $('.barcode-group').on('click', function(){
      scanner = new Instascan.Scanner({ video: document.getElementById('preview'), scanPeriod: 5, mirror: false });
      scanner.addListener('scan',function(content){
        var token = $('input[name="csrfmiddlewaretoken"]').val();
        $('#modal-scanner').modal('hide');
        setTimeout(function(){
          Swal.fire({
            title: 'Konfirmasi Pengiriman ?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: `Ya`,
            confirmButtonColor: '#3085d6',
            html:`<form id='form-scan-resi' method='POST'><input type='hidden' name='csrfmiddlewaretoken' value='${token}'><input type='hidden' value='${content}' name='resi'><input type='hidden' value='sent_by' name='status_pengiriman'><input type='hidden' value='{{ request.user.id }}' name='id_kurir'><div>Apakah anda yakin akan mengkonfirmasi pengiriman tanpa melihat detail data ?</div></form>`,
            cancelButtonColor: '#d33',
            allowOutsideClick: false
          }).then((result) => {
            /* Read more about isConfirmed, isDenied below */
            if (result.value) {
              var form = $('#form-scan-resi')[0];
              var formData = new FormData(form);
              $.ajax({
                url: '/mobile_kurir/kurir_update_status_qr',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(result){
                  setTimeout(function(){
                    Swal.fire({
                      title : 'Sukses',
                      text : result.msg,
                      icon : result.type,
                      allowOutsideClick: false
                    }).then((result)=> {
                      if(result.value) {
                        location.reload()
                      }
                    });
                  },500)
                },
                error: function(xhr){
                  setTimeout(function(){
                    try {
                      console.log(xhr.statusText)
                      if(xhr.statusText=='Forbidden'){
                        Swal.fire('Error','Forbidden Request, silahkan ulangi', 'error');
                        return
                      }

                      var json = JSON.parse(xhr.responseText);
                      Swal.fire({
                        title : 'Error',
                        text : json.msg,
                        icon : json.type,
                        allowOutsideClick: false
                      })
                    }catch(message) {
                      console.log(message)
                      Swal.fire('Terjadi kesalahan', message,'error');
                    }
                  }, 500)
                }
              });
            }
          })
        },500)
        //window.location.href=content;
      });
      Instascan.Camera.getCameras().then(function (cameras){
        if(cameras.length>0){
          $('#modal-scanner').modal('show');
          if(Object.keys(cameras).includes("1")){
            scanner.start(cameras[1]);
            return;
          }
          scanner.start(cameras[0]);
        }else{
          console.error('No cameras found.');
          alert('No cameras found.');
        }
      }).catch(function(e){
        console.error(e);
      });
    });

    $('#modal-scanner').on('hide.bs.modal', function(){
      try {
        scanner.stop()
        .then(function(){
          document.getElementById('#scanner-body-kirim').innerHTML = "<video id='preview'></video>";
        })
      } catch(message) {
        console.log(message)
      }
    });

    var scan_data = [];
    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
      try {
      scanner.stop()
      .then(function(){
          document.getElementById('#scanner-wrapper-sampai').innerHTML = '<video id="scanner-sampai" class="scanner-show shadow"></video>';
      }).catch(error => function(){
        console.log(error);
      });
      } catch(message) {}


      var target = $(e.target).attr("href") // activated tab
      if(target=='#tab_berhasil') {
        scanner = new Instascan.Scanner({ video: document.getElementById('scanner-sampai'), mirror: false });
        scanner.addListener('scan',function(content){
          if(!scan_data.includes(content)){
            var patt = /^ER-[0-9]+/;
            if(!patt.test(content)){
              console.log(content);
              tampilkan_pesan("Resi tidak valid", 'error');
              return
            }
            scan_data.push(content)
            var to_add = "";
            var d = new Date,
            dformat = [(d.getMonth()+1).padLeft(),
                       d.getDate().padLeft(),
                       d.getFullYear()].join('-') +' ' +
                      [d.getHours().padLeft(),
                       d.getMinutes().padLeft(),
                       d.getSeconds().padLeft()].join(':');
            to_add += `<tr><td><input type="hidden" name="id_pengiriman[]" value="${content}"><a href='kurir_pengiriman_detail/${content}'>${content}</a></td><td>${dformat}</td></tr>`;
            $('#scan-data').html('');
            $('#scan-data').append(to_add);
            $('.btn-upload-all-scan').prop('disabled', false);
          }
          else {
            tampilkan_pesan("Resi sudah ada", 'info');
            return
          }
        });
        Instascan.Camera.getCameras().then(function (cameras){
          if(cameras.length>0){
            if(Object.keys(cameras).includes("1")){
              scanner.start(cameras[1]);
              return;
            }
            scanner.start(cameras[0]);
          }else{
            console.error('No cameras found.');
            alert('No cameras found.');
          }
        }).catch(function(e){
          console.error(e);
        });
      }
      else {
        try {
        scanner.stop()
        .then(function(){
            document.getElementById('#scanner-wrapper-sampai').innerHTML = '<video id="scanner-sampai" class="scanner-show shadow"></video>';
        }).catch(error => function(){
          console.log(error);
        });
        } catch(message) {
          console.log(message)
        }
      }
    });


    $('#form-upload-scan').submit(function(e){
      e.preventDefault();
      var upload_scan = $('.btn-upload-all-scan').html()
      $('.btn-upload-all-scan').html('<i class="fas fa-spin fa-spinner"></i>&nbsp;&nbsp;Mengupload Data');
      $('.btn-upload-all-scan').prop('disabled', true);
      // Stop the scanner
      try {
        scanner.stop()
        .then(function(){
            document.getElementById('#scanner-wrapper-sampai').innerHTML = '';
        }).catch(error => function(){
          console.log(error);
        });
      } catch(message) {
        console.log(message)
      }

      var form = $('#form-upload-scan')[0];
      var formData = new FormData(form);
      $.ajax({
        url: '/mobile_kurir/kurir_update_status_sampai',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success : function(result){
          Swal.fire({
            title : 'Sukses',
            text : result.msg,
            icon : result.type,
            allowOutsideClick: false
          }).then((result)=> {
            if(result.value) {
              location.reload()
            }
          });
        },
        error : function(xhr){
          try {
            console.log(xhr.statusText)
            if(xhr.statusText=='Forbidden'){
              Swal.fire('Error','Forbidden Request, silahkan ulangi', 'error');
              return
            }

            var json = JSON.parse(xhr.responseText);
            Swal.fire({
              title : 'Error',
              text : json.msg,
              icon : json.type,
              allowOutsideClick: false
            })
          }catch(message) {
            console.log(message)
            Swal.fire('Terjadi kesalahan', message,'error');
          }
        },
        complete : function(){
          $('.btn-upload-all-scan').html(upload_scan);
          $('.btn-upload-all-scan').prop('disabled', false);
        }
      })


      return false
    })

  });
</script>
{% endblock file_js %}
