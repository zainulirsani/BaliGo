{% extends 'base.html' %}
{% load static %}

{% block title_name %}
 <title>Order Pickup | BaliGo Ekspedisi</title>
{% endblock %}

{% block file_css %}
<!-- DataTables -->
 <link rel="stylesheet" href="{% static 'assets/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css' %}">
 <link rel="stylesheet" href="{% static 'assets/plugins/datatables-responsive/css/responsive.bootstrap4.min.css' %}">
 <!-- SweetAlert2 -->
  <link rel="stylesheet" href="{% static 'assets/plugins/sweetalert2-theme-bootstrap-4/bootstrap-4.min.css' %}">
	
{% endblock %}


{% block content_header %}
<div class="container-fluid">
    <div class="row mb-2">
    	<div class="col-sm-6">
            <h1 class="m-0 text-dark">Order Pick Up</h1>
        </div><!-- /.col -->
	    <div class="col-sm-6">
	    	<ol class="breadcrumb float-sm-right">
	    		<li class="breadcrumb-item"><a href="#">Home</a></li>
	    		<li class="breadcrumb-item active">Order Pick Up</li>
	    	</ol>
	    </div><!-- /.col -->
	</div><!-- /.row -->
</div><!-- /.container-fluid -->
{% endblock %}



{% block content %}
<div class="card">
	<div class="card-header">
		<h3 class="card-title">Data Order Pick Up</h3>
		<div class="card-tools">
			<a href="{% url 'order_pickup' %}" class="btn btn-block bg-gradient-primary">Kembali</a>
    	</div>
	</div>
	<!-- /.card-header -->
	<div class="card-body">
		<table id="order_pickup" class="table table-bordered table-striped" data-url="{{ url_order }}">
			<thead>
				<tr>
					<th>No</th>
					<th>Id Order</th>
					<th>Nama Pelanggan</th>
					<th>Alamat Pengirim</th>
					<th>Status</th>
					<th>Billing</th>
					<th>Action</th>
				</tr>
			</thead>
			<tbody>
				
			</tbody>
			<tfoot>
			<tr>
				<th>No</th>
				<th>Id Order</th>
				<th>Nama Pelanggan</th>
				<th>Alamat Pengirim</th>
				<th>Status</th>
				<th>Billing</th>
				<th>Action</th>
			</tr>
			</tfoot>
		</table>

		
	</div>
	<!-- /.card-body -->
</div>


<!-- /.modal -->
<div class="modal fade" id="modal_order">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title" id="title_modal">Detail Data Order Pickup</h4>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
				<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<form id="orderPickupForm" method="post" data-url="{% url 'order_pickup' %}">
					{% csrf_token %}
					
					<div class="form-group row">
	                    <label for="inputId" class="col-sm-2 col-form-label">Id Order</label>
		                <div class="col-sm-10">
		                   	<input type="text" class="form-control" id="inputId">
		                </div>
	                </div>

	                <div class="form-group row">
	                    <label for="inputIdCustomer" class="col-sm-2 col-form-label">Id Customer</label>
		                <div class="col-sm-10">
		                   	<input type="text" class="form-control" id="inputIdCustomer">
		                </div>
	                </div>

	                <div class="form-group row">
	                    <label for="inputNamaCustomer" class="col-sm-2 col-form-label">Nama Customer</label>
		                <div class="col-sm-10">
		                   	<input type="text" class="form-control" id="inputNamaCustomer">
		                </div>
	                </div>

	                <div class="form-group row">
	                    <label for="inputNoTlp" class="col-sm-2 col-form-label">No. Tlp</label>
		                <div class="col-sm-10">
		                   	<input type="text" class="form-control" id="inputNoTlp">
		                </div>
	                </div>

	                <div class="form-group row">
	                    <label for="inputJenisBarang" class="col-sm-2 col-form-label">Jenis Barang</label>
		                <div class="col-sm-10">
		                   	<input type="text" class="form-control" id="inputJenisBarang">
		                </div>
	                </div>

	                <div class="form-group row">
	                    <label for="inputDetailBarang" class="col-sm-2 col-form-label">Detail Barang</label>
		                <div class="col-sm-10">
		                   	<input type="text" class="form-control" id="inputDetailBarang">
		                </div>
	                </div>

	                <div class="form-group row">
	                    <label for="inputJenisPengiriman" class="col-sm-2 col-form-label">Jenis Pengiriman</label>
		                <div class="col-sm-10">
		                   	<input type="text" class="form-control" id="inputJenisPengiriman">
		                </div>
	                </div>

	                <div class="form-group row">
	                    <label for="inputIdPengemasan" class="col-sm-2 col-form-label">Jenis Pengemasan</label>
		                <div class="col-sm-10">
		                   	<input type="text" class="form-control" id="inputIdPengemasan">
		                </div>
	                </div>

	                <div class="form-group row">
	                    <label for="inputAlamatPengirim" class="col-sm-2 col-form-label">Alamat Pengiriman</label>
		                <div class="col-sm-10">
		                   	<textarea class="form-control" rows="3" id="inputAlamatPengirim">
		                   		
		                   	</textarea>
		                </div>
	                </div>

	                <div class="form-group row">
	                    <label for="inputNamaPenerima" class="col-sm-2 col-form-label">Nama Penerima</label>
		                <div class="col-sm-10">
		                   	<input type="text" class="form-control" id="inputNamaPenerima">
		                </div>
	                </div>

	                <div class="form-group row">
	                    <label for="inputNoTlpPenerima" class="col-sm-2 col-form-label">No.Tlp Penerima</label>
		                <div class="col-sm-10">
		                   	<input type="text" class="form-control" id="inputNoTlpPenerima">
		                </div>
	                </div>

	                <div class="form-group row">
	                    <label for="inputEmailPenerima" class="col-sm-2 col-form-label">Email Penerima</label>
		                <div class="col-sm-10">
		                   	<input type="text" class="form-control" id="inputEmailPenerima">
		                </div>
	                </div>

	                <div class="form-group row">
	                    <label for="inputAlamatPenerima" class="col-sm-2 col-form-label">Alamat Penerima</label>
		                <div class="col-sm-10">
		                   	<input type="text" class="form-control" id="inputAlamatPenerima">
		                </div>
	                </div>

	                <div class="form-group row">
	                    <label for="inputNamaToko" class="col-sm-2 col-form-label">Outlet</label>
		                <div class="col-sm-10">
		                   	<input type="text" class="form-control" id="inputNamaToko">
		                </div>
	                </div>

	                <div class="form-group row">
	                    <label for="inputStatus" class="col-sm-2 col-form-label">Status</label>
		                <div class="col-sm-10">
		                   	<select class="form-control" id="inputStatus" name="status">
							  <option value="approve">Approve</option>
							  <option value="pickup">Pick Up</option>
							  <option value="done">Done</option>
							</select>
		                </div>
	                </div>
					
				</form>
				
			</div>
			<div class="modal-footer justify-content-between">
				<button type="button" class="btn btn-default" data-dismiss="modal">Tutup</button>
				<button type="button" class="btn btn-primary" id="updateButton" data-url="">Kirim Notifikasi Ke Kurir</button>
			</div>
		</div>
		<!-- /.modal-content -->
	</div>
	<!-- /.modal-dialog -->
</div>
<!-- /.modal -->



{% endblock %}




{% block file_js %}
<!-- Bootstrap 4 -->
<script src="{% static 'assets/plugins/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
<!-- DataTables -->
<script src="{% static 'assets/plugins/datatables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'assets/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js' %}"></script>
<script src="{% static 'assets/plugins/datatables-responsive/js/dataTables.responsive.min.js' %}"></script>
<script src="{% static 'assets/plugins/datatables-responsive/js/responsive.bootstrap4.min.js' %}"></script>
<!-- SweetAlert2 -->
<script src="{% static 'assets/plugins/sweetalert2/sweetalert2.min.js' %}"></script>

<script>
	$(document).ready(function(){
		var csrfToken = $("input[name=csrfmiddlewaretoken]").val();
		var url_edit = '';

		function tampilkan_pesan(pesan, type){
	    	Toast.fire({
	        icon: type,
	        title: pesan
	      });
	    }


	    function get_current_url() {
	    	return window.location.href;
	    }
    

	    function generate_token(){
	    	var now = new Date();
			timestamp = now.getFullYear().toString(); // 2011
			timestamp += (now.getMonth < 12 ? '0' : '') + now.getMonth().toString();
			timestamp += ((now.getDate < 30) ? '0' : '') + now.getDate().toString();
			timestamp += ((now.getHours < 12) ? '0' : '') + now.getHours().toString();
			timestamp += ((now.getMinutes < 60) ? '0' : '') + now.getMinutes().toString();
			timestamp += ((now.getSeconds < 60) ? '0' : '') + now.getSeconds().toString();
			return timestamp;
	    }

		const Toast = Swal.mixin({
	      toast: true,
	      position: 'top-end',
	      showConfirmButton: false,
	      timer: 3000
	    });

		var table = $('#order_pickup').DataTable({

	      "paging": true,
	      "lengthChange": false,
	      "searching": true,
	      "ordering": true,
	      "info": true,
	      "autoWidth": false,
	      "responsive": true,
	      "processing" : true,
	      "serverside" : true,
	      "ajax" : {
	      	"url" : get_current_url(),
	      	"type" : "get"
	      }
	    });


	    //DETAIL DATA
		$('body').on('click', '.detailOrderPickup', function(event){
			event.preventDefault();
			var id_order = $(this).data("id");
			var url_detail = "{% url 'pickup_list_outlet' %}" + "order/" + id_order + "/";
			

			$.ajax({
				url: url_detail,
				type: 'get',
				success: function(response){
					document.getElementById("inputId").value = response.order_pickup.id_order;
					document.getElementById("inputIdCustomer").value = response.pelanggan.id_pelanggan;
					document.getElementById("inputNamaCustomer").value = response.pelanggan.nama_pelanggan;
					document.getElementById("inputNoTlp").value = response.pelanggan.no_tlp;
					document.getElementById("inputJenisBarang").value = response.order_pickup.jenis_barang;
					document.getElementById("inputDetailBarang").value = response.order_pickup.detail_barang;
					document.getElementById("inputJenisPengiriman").value = response.order_pickup.jenis_pengiriman;
					document.getElementById("inputIdPengemasan").value = response.pengemasan.nama_pengemasan;
					document.getElementById("inputAlamatPengirim").value = response.pelanggan.alamat;
					document.getElementById("inputNamaPenerima").value = response.order_pickup.nama_penerima;
					document.getElementById("inputNoTlpPenerima").value = response.order_pickup.no_tlp_penerima;
					document.getElementById("inputEmailPenerima").value = response.order_pickup.email_penerima;
					document.getElementById("inputAlamatPenerima").value = response.order_pickup.alamat_penerima;
		
					document.getElementById("inputNamaToko").value = response.toko.nama_toko;
					
					
					document.getElementById("inputStatus").value = response.order_pickup.status;

					
					document.getElementById("inputId").disabled = true;
					document.getElementById("inputIdCustomer").disabled = true;
					document.getElementById("inputNamaCustomer").disabled = true;
					document.getElementById("inputNoTlp").disabled = true;
					document.getElementById("inputJenisBarang").disabled = true;
					document.getElementById("inputDetailBarang").disabled = true;
					document.getElementById("inputJenisPengiriman").disabled = true;
					document.getElementById("inputIdPengemasan").disabled = true;
					document.getElementById("inputAlamatPengirim").disabled = true;
					document.getElementById("inputNamaPenerima").disabled = true;
					document.getElementById("inputNoTlpPenerima").disabled = true;
					document.getElementById("inputEmailPenerima").disabled = true;
					document.getElementById("inputAlamatPenerima").disabled = true;
					document.getElementById("inputNamaToko").disabled = true;
					document.getElementById("inputStatus").disabled = false;
					
					if(response.order_pickup.status=='approve'){
						document.getElementById("inputStatus").selectedIndex = "0";
					}else if(response.order_pickup.status=='pickup'){
						document.getElementById("inputStatus").selectedIndex = "1";
					}else if(response.order_pickup.status=='done'){
						document.getElementById("inputStatus").selectedIndex = "2";
					}else{
						document.getElementById("inputStatus").selectedIndex = "-1";
					}
					

					document.getElementById("title_modal").innerHTML = "Detail Data Gudang";
					$('#updateButton').attr('data-url',url_detail); //setter
					$('#modal_order').modal('show');
				}
			})
			
		});

		$("#updateButton").click(function(e){
			e.preventDefault();
			var url_update = $(this).data("url");
			var serializeData = $("#orderPickupForm").serialize();

			$.ajax({
				url: url_update,
				data: serializeData,
				type: 'post',
				cache: false,
				success: function(response){
					$('#modal_order').modal('hide');
					tampilkan_pesan(response.msg, response.type);
				},
				error: function(xhr, status, error){
					var error_response = xhr.responseJSON;

					tampilkan_pesan(error_response.msg, error_response.type);
				},
			})


		});

		$('body').on('click', '.downloadBilling', function(event) {
			event.preventDefault();
			var id_order = $(this).data("id");

			var url_detail = "{% url 'pickup_list_outlet' %}" + "order/" + id_order + "/";
			var today = new Date();
			var dd = String(today.getDate()).padStart(2, '0');
			var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
			var yyyy = today.getFullYear();
			
			today = mm + '/' + dd + '/' + yyyy;
			$.ajax({
				url: url_detail,
				type: 'get',
				success: function(response){
					
					var printWindow = window.open('', '', 'height=400,width=800');
            		printWindow.document.write('<html><head><title>Data Order PickUp - ' + response.order_pickup.id_order + '</title>');
            		printWindow.document.write('<style id="style_billing">.invoice-box {max-width: 800px;margin: auto;padding: 30px;border: 1px solid #eee;box-shadow: 0 0 10px rgba(0, 0, 0, .15);font-size: 16px;line-height: 24px;font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif;color: #555;}.invoice-box table {width: 100%;line-height: inherit;text-align: left;}.invoice-box table td {padding: 5px;vertical-align: top;}.invoice-box table tr td:nth-child(2) {text-align: right;}.invoice-box table tr.top table td {padding-bottom: 20px;}.invoice-box table tr.top table td.title {font-size: 45px;line-height: 45px;color: #333;}.invoice-box table tr.information table td {padding-bottom: 40px;}.invoice-box table tr.heading td {background: #eee;border-bottom: 1px solid #ddd;font-weight: bold;}.invoice-box table tr.details td {padding-bottom: 20px;}.invoice-box table tr.item td{border-bottom: 1px solid #eee;}.invoice-box table tr.item.last td {border-bottom: none;}.invoice-box table tr.total td:nth-child(2) {border-top: 2px solid #eee;font-weight: bold;}@media only screen and (max-width: 600px) {.invoice-box table tr.top table td {width: 100%;display: block;text-align: center;}.invoice-box table tr.information table td {width: 100%;display: block;text-align: center;}}.rtl {direction: rtl;font-family: Tahoma, "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif;}.rtl table {text-align: right;}.rtl table tr td:nth-child(2) {text-align: left;}</style>');
            		printWindow.document.write('</head><body >');
            		printWindow.document.write('<div class="invoice-box"><table cellpadding="0" cellspacing="0"><tr class="top"><td colspan="2"><table><tr><td class="title"><img src=\'{% static "assets/dist/img/logo2.jpg" %}\' style="width:100%; max-width:300px;"></td>');
            		printWindow.document.write('<td>Invoice #: ' + response.order_pickup.id_order + '<br>Created: ' + today + '<br>Tgl Order: '+response.tgl_order+'</td></tr></table></td></tr>');
            		printWindow.document.write('<tr class="information"><td colspan="2"><table><tr><td>Nama Pengirim:' + response.pelanggan.nama_pelanggan + '<br>No. Hp:' + response.pelanggan.no_tlp + '<br>' + response.pelanggan.alamat + '</td>');
            		printWindow.document.write('<td>SAMITRA EKSPEDISI<br>Bali<br>admin@samitra.id</td></tr></table></td></tr><tr class="heading"><td>Jenis Pengiriman</td><td>Jenis Pengemasan</td></tr><tr class="details"><td>' + response.order_pickup.jenis_pengiriman + '</td><td>' + response.pengemasan.nama_pengemasan + '</td></tr>');
            		printWindow.document.write('<tr class="heading"><td>DETAIL TUJUAN</td><td>DATA</td></tr>');
            		printWindow.document.write('<tr class="item"><td>Nama Penerima</td><td>' + response.order_pickup.nama_penerima + '</td></tr>');
            		printWindow.document.write('<tr class="item"><td>Alamat Penerima</td><td>' + response.order_pickup.alamat_penerima + '</td></tr>');
            		printWindow.document.write('<tr class="item"><td>No Tlp.</td><td>'+ response.order_pickup.no_tlp_penerima +'</td></tr>');
            		printWindow.document.write('<tr class="item last"><td>Email</td><td>'+ response.order_pickup.email_penerima +'</td></tr>');
            		printWindow.document.write('<tr class="total"><td></td><td>Status: ' + response.order_pickup.status + '</td></tr></table></div>');
            		
            		printWindow.document.write('</body></html>');
            		printWindow.document.close();
           			printWindow.print();
				}
			})  
        });

	});
</script>
{% endblock %}
